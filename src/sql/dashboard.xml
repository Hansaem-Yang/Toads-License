<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dashboard">  
    <select id="satellite_usage">
    <![CDATA[
        select a.company_no
             , a.company_name
             , isnull((select sum(datediff(second, connect_date, disconnect_date)) 
        	               from ToadsSLink.dbo.contract_connect_history
        		            where company_id = a.company_no), 0) as total_usage
             , isnull((select sum(datediff(second, connect_date, disconnect_date)) 
        	               from ToadsSLink.dbo.contract_connect_history
        		            where company_id = a.company_no
        		              and convert(varchar(4), connect_date, 112) = convert(varchar(4), getdate(), 112)), 0) as annual_usage
             , isnull((select sum(datediff(second, connect_date, disconnect_date)) 
        	               from ToadsSLink.dbo.contract_connect_history
        		            where company_id = a.company_no
        		              and convert(varchar(6), connect_date, 112) = convert(varchar(6), getdate(), 112)), 0) as monthly_usage
             , isnull((select sum(datediff(second, connect_date, disconnect_date)) 
        	               from ToadsSLink.dbo.contract_connect_history
        		            where company_id = a.company_no
        		              and convert(varchar(8), connect_date, 112) = convert(varchar(8), getdate(), 112)), 0) as daliy_usage
             , (select count(1)
        	        from ToadsLicense.dbo.vw_ts_app_user
        		     where company_no = a.company_no) as total_users
          from ToadsLicense.dbo.company as a
    ]]>
    </select>
    <select id="annual_satellite_usage">
    <![CDATA[
        select a.company_no
             , a.company_name
             , month(b.connect_date) period
             , sum(datediff(second, b.connect_date, b.disconnect_date)) usage
          from ToadsLicense.dbo.company as a
         inner join ToadsSLink.dbo.contract_connect_history as b
            on a.company_no = b.company_id
         where convert(varchar(4), b.connect_date, 112) = convert(varchar(4), getdate(), 112)
         group by a.company_no
                , a.company_name
                , month(b.connect_date)
         order by 1, 2, 3
    ]]>
    </select>
    <select id="monthly_satellite_usage">
    <![CDATA[
        select a.company_no
             , a.company_name
             , month(b.connect_date) period
             , sum(datediff(second, b.connect_date, b.disconnect_date)) usage
          from ToadsLicense.dbo.company as a
         inner join ToadsSLink.dbo.contract_connect_history as b
            on a.company_no = b.company_id
         where convert(varchar(6), b.connect_date, 112) = convert(varchar(6), getdate(), 112)
         group by a.company_no
                , a.company_name
                , month(b.connect_date)
         order by 1, 2, 3
    ]]>
    </select>
    <select id="satellite_usage_by_user">
    <![CDATA[
        select a.company_no
             , a.company_name
             , isnull((select sum(datediff(second, connect_date, disconnect_date))
        	               from ToadsSLink.dbo.contract_connect_history
        		            where company_id = a.company_no), 0) as total_usage
             , isnull((select sum(datediff(second, connect_date, disconnect_date)) 
        	               from ToadsSLink.dbo.contract_connect_history
        		            where company_id = a.company_no
        		              and convert(varchar(4), connect_date, 112) = convert(varchar(4), getdate(), 112)), 0) as annual_usage
             , isnull((select sum(datediff(second, connect_date, disconnect_date)) 
        	               from ToadsSLink.dbo.contract_connect_history
        		            where company_id = a.company_no
        		              and convert(varchar(6), connect_date, 112) = convert(varchar(6), getdate(), 112)), 0) as monthly_usage
             , isnull((select sum(datediff(second, connect_date, disconnect_date)) 
        	               from ToadsSLink.dbo.contract_connect_history
        		            where company_id = a.company_no
        		              and convert(varchar(8), connect_date, 112) = convert(varchar(8), getdate(), 112)), 0) as daliy_usage
             , (select count(1)
        	        from ToadsLicense.dbo.vw_ts_app_user
        		     where company_no = a.company_no) as total_users
          from ToadsLicense.dbo.company as a
         where a.company_no = #{companyNo}
    ]]>
    </select>
    <select id="annual_satellite_usage_by_user">
    <![CDATA[
        select a.company_no
             , a.company_name
             , month(b.connect_date) period
             , sum(datediff(second, b.connect_date, b.disconnect_date)) usage
          from ToadsLicense.dbo.company as a
         inner join ToadsSLink.dbo.contract_connect_history as b
            on a.company_no = b.company_id
         where a.company_no = #{companyNo}
           and convert(varchar(4), b.connect_date, 112) = convert(varchar(4), getdate(), 112)
         group by a.company_no
                , a.company_name
                , month(b.connect_date)
         order by 1, 2, 3
    ]]>
    </select>
    <select id="monthly_satellite_usage_by_user">
    <![CDATA[
        select a.company_no
             , a.company_name
             , day(b.connect_date) period
             , sum(datediff(second, b.connect_date, b.disconnect_date)) usage
          from ToadsLicense.dbo.company as a
         inner join ToadsSLink.dbo.contract_connect_history as b
            on a.company_no = b.company_id
         where a.company_no = #{companyNo}
           and convert(varchar(6), b.connect_date, 112) = convert(varchar(6), getdate(), 112)
         group by a.company_no
                , a.company_name
                , day(b.connect_date)
         order by 1, 2, 3
    ]]>
    </select>
    <select id="company_all">
    <![CDATA[
        select a.company_no
             , a.company_name
             , a.owner_name
             , isnull(a.company_div, '') company_div
             , isnull(a.nation, '') nation
             , isnull(b.nation_code, '') nation_code
             , isnull(a.telephone, '') telephone
             , (select isnull(sum(license_count), 0) from license
                 where company_no = a.company_no
                   and start_date >= convert(varchar(10), getdate(), 20)
                   and end_date <= convert(varchar(10), getdate(), 20)) as total_licenses
             , (select sum(cnt)
                  from (select count(1) as cnt 
                          from manager as aa
                         inner join employee as bb
                            on aa.emp_no = bb.emp_no
                         where bb.company_no = a.company_no
                        union all
                        select count(1) from vw_ts_app_user
                         where company_no = a.company_no
                           and use_yn = 'Y'
                           and apply_start_date <= convert(varchar(10), getdate(), 121)
                           and apply_finish_date >= convert(varchar(10), getdate(), 121)) as a) as total_users
             , 0 as total_satellite_usage
          from company as a
          left outer join nations as b
            on a.nation = b.nation_iso2
    ]]>
    </select>
    <select id="company">
    <![CDATA[
        select a.company_no
             , a.company_name
             , a.owner_name
             , isnull(a.company_div, '') company_div
             , isnull(a.nation, '') nation
             , isnull(b.nation_code, '') nation_code
             , isnull(a.telephone, '') telephone
             , (select isnull(sum(license_count), 0) from license
                 where company_no = a.company_no
                   and start_date >= convert(varchar(10), getdate(), 20)
                   and end_date <= convert(varchar(10), getdate(), 20)) as total_licenses
             , (select count(1) from vw_ts_app_user
                 where company_no = a.company_no
                   and use_yn = 'Y'
                   and apply_start_date <= convert(varchar(10), getdate(), 121)
                   and apply_finish_date >= convert(varchar(10), getdate(), 121)) as total_users
             , 0 as total_satellite_usage
          from company as a
          left outer join nations as b
            on a.nation = b.nation_iso2
         where a.company_no = #{companyNo}
    ]]>
    </select>
</mapper>