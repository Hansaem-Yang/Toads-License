<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="/public/css/content-styles.css">
        <!--
        <link rel="stylesheet" media="screen and (max-width: 600px)" href="/public/css/styles-small.css">
        <link rel="stylesheet" media="screen and (min-width: 601px) and (max-width: 1024px)" href="/public/css/styles-medium.css">
        <link rel="stylesheet" media="screen and (min-width: 1025px) and (max-width: 2560px)" href="/public/css/styles-large.css">
        -->
        <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="/public/js/common/<%= i18n.language %>/common_variables.js"></script>
        <script src="/public/js/common/common_utility.js"></script>
        <script>
            $(document).ready(function() {
                var companyNo = $('.company_no').val();

                $.ajax({
                    url: "../user/dashboard/satelliteUsageByUser",
                    method: "POST",
                    dataType: 'json',
                    data: {
                        companyNo: companyNo,
                    },
                    success: function (data) {
                        ClearUsage();

                        if (data === 'NO SESSION') {
                            alert("<%=t('message(session expires)')%>");
                            window.parent.location.href = "./login";
                        } else if (data === 'NO DATA') {
                            var newRow = '<tr><td colspan="6"><%=t("message(no data)")%></td></tr>';
                            $('.satellite-usage').append(newRow);
                        } else {
                            if (Array.isArray(data)) {
                                $.each(data, function(index, post) {
                                    var newRow = $('.satellite-usage tbody tr').first().clone().removeClass('hidden');

                                    $(newRow).find('.cell_company_name').text(post.companyName);
                                    $(newRow).find('.cell_total_users').text(post.totalUsers);
                                    $(newRow).find('.cell_total_usage').text(formatCurrency(ConvertMinute(post.totalUsage)));
                                    $(newRow).find('.cell_annual_usage').text(formatCurrency(ConvertMinute(post.annualUsage)));
                                    $(newRow).find('.cell_monthly_usage').text(formatCurrency(ConvertMinute(post.monthlyUsage)));
                                    $(newRow).find('.cell_daliy_usage').text(formatCurrency(ConvertMinute(post.daliyUsage)));

                                    $('.satellite-usage tbody').append(newRow);
                                });
                            }
                        }
                    },
                    error: function (xhr, status, error) {
                        var newRow = '<tr><td colspan="6"><%=t("message(request failed)")%></td></tr>';
                        $('.satellite-usage').append(newRow);
                    },
                });
                    
                let months = [];
                let annualUsages = [];
                let annualBarCtx = document.getElementById('annualBarChart').getContext('2d');

                $.ajax({
                    url: "../user/dashboard/annualSatelliteUsageByUser",
                    method: "POST",
                    dataType: 'json',
                    data: {
                        companyNo: companyNo,
                    },
                    success: function (data) {
                        ClearUsage();

                        if (data === 'NO SESSION') {
                            alert("<%=t('message(session expires)')%>");
                            window.parent.location.href = "./login";
                        } else if (data === 'NO DATA') {
                            months = [];
                            annualUsages = [];
                        } else {
                            if (Array.isArray(data)) {
                                $.each(data, function(index, post) {
                                    months.push(post.period);
                                    annualUsages.push(ConvertMinute(post.usage));
                                });
                            }
                        }

                        new Chart(annualBarCtx, {
                            type: 'bar',
                            data: {
                                labels: months,
                                datasets: [{
                                    label: "<%=t('annual usage')%>",
                                    data: annualUsages,
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    borderWidth: 1,
                                }],
                            },
                            options: {
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                    },
                                },
                            },
                        });
                    },
                    error: function (xhr, status, error) {
                        new Chart(annualBarCtx, {
                            type: 'bar',
                            data: {
                                labels: months,
                                datasets: [{
                                    label: "<%=t('annual usage')%>",
                                    data: annualUsages,
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    borderWidth: 1,
                                }],
                            },
                            options: {
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                    },
                                },
                            },
                        });
                    },
                });
                    
                let days = [];
                let monthlyUsages = [];
                let monthlyBarCtx = document.getElementById('monthlyBarChart').getContext('2d');

                $.ajax({
                    url: "../user/dashboard/monthlySatelliteUsageByUser",
                    method: "POST",
                    dataType: 'json',
                    data: {
                        companyNo: companyNo,
                    },
                    success: function (data) {
                        ClearUsage();

                        if (data === 'NO SESSION') {
                            alert("<%=t('message(session expires)')%>");
                            window.parent.location.href = "./login";
                        } else if (data === 'NO DATA') {
                            days = [];
                            monthlyUsages = [];
                        } else {
                            if (Array.isArray(data)) {
                                $.each(data, function(index, post) {
                                    days.push(post.period);
                                    monthlyUsages.push(ConvertMinute(post.usage));
                                });
                            }
                        }

                        new Chart(monthlyBarCtx, {
                            type: 'bar',
                            data: {
                                labels: days,
                                datasets: [{
                                    label: "<%=t('monthly usage')%>",
                                    data: monthlyUsages,
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    borderWidth: 1,
                                }],
                            },
                            options: {
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                    },
                                },
                            },
                        });
                    },
                    error: function (xhr, status, error) {
                        new Chart(monthlyBarCtx, {
                            type: 'bar',
                            data: {
                                labels: months,
                                datasets: [{
                                    label: 'Monthly Usage',
                                    data: annualUsages,
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    borderWidth: 1,
                                }],
                            },
                            options: {
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                    },
                                },
                            },
                        });
                    },
                });

                // $.ajax({
                //     url: "../user/dashboard/company",
                //     method: "POST",
                //     dataType: 'json',
                //     data: {
                //         companyNo: companyNo,
                //     },
                //     success: function (data) {
                //         ClearCompany();

                //         if (data === 'NO SESSION') {
                //             alert("<%=t('message(session expires)')%>");
                //             window.parent.location.href = "./login";
                //         } else if (data === 'NO DATA') {
                //             var newRow = '<tr><td colspan="7" class="left-align"><%=t("message(no data)")%></td></tr>';
                //             $('.company').append(newRow);
                //         } else {
                //             if (Array.isArray(data)) {
                //                 $.each(data, function(index, post) {
                //                     var newRow = $('.company tbody tr').first().clone().removeClass('hidden');

                //                     $(newRow).find('.cell_company_no').text(post.companyNo);
                //                     $(newRow).find('.cell_company_name').text(post.companyName);
                //                     $(newRow).find('.cell_owner_name').text(post.ownerName);
                //                     $(newRow).find('.cell_company_div').text(companyDivs[post.companyDiv]);
                //                     $(newRow).find('.cell_telephone').text(getTelephone(post.nationCode, post.telephone));
                //                     $(newRow).find('.cell_total_licenses').text(post.totalLicenses);
                //                     $(newRow).find('.cell_total_users').text(post.totalUsers);

                //                     $('.company tbody').append(newRow);
                //                 });
                //             }
                //         }
                //     },
                //     error: function (xhr, status, error) {
                //         var newRow = '<tr><td colspan="7" class="left-align"><%=t("message(request failed)")%></td></tr>';
                //         $('.company').append(newRow);
                //     },
                // });
            });
            
            var ClearUsage= function() {
                const rows = document.querySelectorAll(".satellite-usage tbody tr:not(:first-child)");
                rows.forEach(row => {
                    row.remove();
                });
            }
            
            var ClearCompany = function() {
                const rows = document.querySelectorAll(".company tbody tr:not(:first-child)");
                rows.forEach(row => {
                    row.remove();
                });
            }
        </script>
    </head>
    <body>
        <form class="home-form" class="container">
            <input type="hidden" class="company_no" value="<%= session.user.companyNo %>"/>
            <input type="hidden" class="account_no" value="<%= session.user.accountNo %>"/>
            <div class="content">
                <div>
                    <div class="title"><%=t('total slink usage')%></div>
                    <div>
                        <table class="satellite-usage">
                            <thead>
                                <tr>
                                    <th width="240px"><%=t('client company')%></th>
                                    <th width="160px"><%=t('total users')%></th>
                                    <th width="160px"><%=t('total usage')%></th>
                                    <th width="160px"><%=t('annual usage')%></th>
                                    <th width="160px"><%=t('monthly usage')%></th>
                                    <th width="160px"><%=t('daily usage')%></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="hidden">
                                    <td class="cell_company_name" style="text-align: left;"></td>
                                    <td class="cell_total_users" style="text-align: right;"></td>
                                    <td class="cell_total_usage" style="text-align: right;"></td>
                                    <td class="cell_annual_usage" style="text-align: right;"></td>
                                    <td class="cell_monthly_usage" style="text-align: right;"></td>
                                    <td class="cell_daliy_usage" style="text-align: right;"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div></br></br></br>
                <div>
                    <table>
                        <tbody>
                            <tr>
                                <td width="520px" style="text-align: center;">
                                    <canvas id="annualBarChart" width="400" height="200"></canvas>
                                </td>
                                <td width="520px" style="text-align: center;">
                                    <canvas id="monthlyBarChart" width="400" height="200"></canvas>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    
                </div>
                <!--
                <div>
                    <div class="title"><%=t('company information')%></div>
                    <div>
                        <table class="company">
                            <thead>
                                <tr>
                                    <th width="100px"><%=t('company number')%></th>
                                    <th width="240px"><%=t('corporation name')%></th>
                                    <th width="220px"><%=t('representative name')%></th>
                                    <th width="120px"><%=t('company classification')%></th>
                                    <th width="160px"><%=t('country')%></th>
                                    <th width="160px"><%=t('license count')%></th>
                                    <th width="120px"><%=t('user count')%></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="hidden">
                                    <td class="cell_company_no" style="text-align: center;"></td>
                                    <td class="cell_company_name"></td>
                                    <td class="cell_owner_name" style="text-align: center;"></td>
                                    <td class="cell_company_div" style="text-align: center;"></td>
                                    <td class="cell_telephone" style="text-align: center;"></td>
                                    <td class="cell_total_licenses" style="text-align: right;"></td>
                                    <td class="cell_total_users" style="text-align: right;"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                -->
            </div>
        </form>
    </body>
</html>
